#!/bin/bash

#
# -A generate the Atrophy report
#
# alohaDriver -v -o none 66e4737e1b4b58bc3236d6d1
# where  66e4737e1b4b58bc3236d6d1 is a subject id
# just generats the AlohaInputs.json file
#
# alohaDriver -v -o site 66e4737e1b4b58bc3236d6d1
# generates the AlohaInputs.json file and uploads to the flywheel subject
#
# alohaDriver -v -u 66e4737e1b4b58bc3236d61d
# regenerate the json files which take a long time to dig out of flywheel
#
# alohaDriver -v -d 66e4737e1b4b58bc3236d61d
# Just download the aloha input files
#
# alohaDriver -v -r 66e4737e1b4b58bc3236d61d
# Run the aloha script
#
# alohaDriver -R 66e4737e1b4b58bc3236d61d
# Run the report
#
# -a download AlohaInputs.json from the flywheel subject container 
# -d download input files
#
# *** The ignore/run/Fake logic is not correct.
#
# -f Comma separated list of portions json collection to fake
#    IgnoreBaselineAshsPmcT1JobId|IgnoreBaselineAshsPmcT2JobId
#    IgnoreBaselineT1DicomJson|IgnoreBaselineT1LeftSegmentationJson|IgnoreBaselineT1NiftiTrimmedJson|IgnoreBaselineT1RightSegmentationJson
#    IgnoreBaselineT2DicomJson|IgnoreBaselineT2LeftSegmentationJson|IgnoreBaselineT2NiftiJson|IgnoreBaselineT2RightSegmentationJson
#    IgnoreFollowupT1DicomJson|IgnoreFollowupT1NiftiTrimmedJson|IgnoreFollowupT2DicomJson|IgnoreFollowupT2NiftiJson
#    IgnoreAlohaRun
#
#    RunAshsPmcT1Gear|RunBaselineAshsPmcT2Gear
#    RunBaselineT1Dcm2NiixGear|RunBaselineT1NecktrimGear
#    RunBaselineT2Dcm2NiixGear|RunFollowupT1Dcm2NiixGear|RunFollowupT1NecktrimGear|RunFollowupT2Dcm2NiixGear
#
#        alohaDriver -f RunBaselineT1Dcm2NiixGear,RunBaselineT2Dcm2NiixGear -o stdout 66e4737e1b4b58bc3236d61d 
#
# -j JobId
# -m MachineTag - tag to use change the default machine size
# -n no-op
# -o [site|stdout|none]
#     create AlohaInputs.json and upload it to the flywheel site, print to stdout, neither
#     the AlohaInputs.json file will not be created unless -o is part of the command line
# -r run aloha code
# -u update files that take a long time to get
# -v verbose

CmdName=$(basename "$0")

FwDir=$(dirname $(dirname $(which fwget)))
FwLibDir="${FwDir}/lib"

function sys {
    [ -n "${opt_n}${opt_v}" ] && echo "$@" 1>&2
    [ -n "$opt_n" ] || "$@"
}

while getopts Aadf:j:m:no:ruv arg
do
	case "$arg" in
	     A|a|d|f|j|m|n|o|r|u|v)
		eval "opt_${arg}='${OPTARG:=1}'"
		;;
	esac
done

shift $(( "$OPTIND" - 1 ))

[ "$opt_u" ] && UpdateAll=1

TmpDir="/tmp/Aloha"
[ -e "$TmpDir" ] || mkdir -p "$TmpDir"
AlohaInputsJsonFile="${TmpDir}/AlohaInputs.json"

AlohaWorkDir="${TmpDir}/Work"
[ -e "$AlohaWorkDir" ] || mkdir -p "$AlohaWorkDir"

SubjectId="$1"
SubjectJsonFile="${TmpDir}/Subject.json"

if [ ! \( \( -e "$SubjectJsonFile" \) -a \( -s "$SubjectJsonFile" \) \) ] || [ -n "$UpdateAll" ] 
then
	sys fwget -1 -raGz "$SubjectId" > "$SubjectJsonFile"
	if [ "$?" != 0 ]
	then
		echo "${CmdName} : failed getting subject '$SubjectId'" 1>&2
		exit 1
	fi
fi
SubjectLabel=$(jq -r '.label' "$SubjectJsonFile")
Group=$(jq -r '.parents.group' "$SubjectJsonFile")

if [ -n "$opt_m" ]
then
    GearTags="$opt_m"
else
    GearTags='extra-large'
fi

FollowupDir="${TmpDir}/Followups"
BaselineJsonFile="${TmpDir}/Baseline.json"
BaselineDir="${TmpDir}/Baseline"

[ -d "$BaselineDir" ] || mkdir -p "$BaselineDir"

SortedSessionsJsonFile="${TmpDir}/SortedSessions.json"
jq -r  -L "$FwLibDir" -f alohaSortSessions.jq "$SubjectJsonFile" > "$SortedSessionsJsonFile"
    
# *** Don't need acquisition info as that will be in the T1/T2 stanzas
BaselineJson=$(jq -r '.Baseline' "$SortedSessionsJsonFile")
if [ -z "$BaselineJson" ] || [ "$BaselineJson" = 'null' ]
then
    echo "${CmdName} : Missing Baseline session" 1>&2
    exit 2
fi
BaselineSessionLabel=$(echo "$BaselineJson" | jq -r '.SessionLabel')

if [ -n "$opt_o" ]
then

    FollowupCount=$(jq -r '[.Followups[] | select(.)] | length' "$SortedSessionsJsonFile")
    # *** should make sure not all the followup sessions are null
    if [ 0 -ge "$FollowupCount" ] 
    then
    	echo "${CmdName} : Missing Followup sessions" 1>&2
    	exit 3
    fi
    
    BaselineSessionId=$(echo "$BaselineJson" | jq -r '.SessionId')
    BaselineSessionJsonFile="${TmpDir}/BaselineSession.json"
    jq -r '..|select(._id == "'"$BaselineSessionId"'")?' "$SubjectJsonFile" > "$BaselineSessionJsonFile"
    
    BaselineJobsJsonFile="${TmpDir}/BaselineJobs.json"
    BaselineJobsJsonTmpFile="${TmpDir}/BaselineJobs.json.tmp"
    if [ ! \( \( -e "$BaselineJobsJsonFile" \) -a \( -s "$BaselineJobsJsonFile" \) \) ] || [ -n "$UpdateAll" ]
    then
	# Need -r to get the output file id
    	sys fwfind -1 -j -r session="$BaselineSessionId" > "$BaselineJobsJsonTmpFile"
    	if [ "$?" != 0 ]
    	then
    		echo "${CmdName} : failed getting finding jobs for '$SessionLabel' ($SessionId)" 1>&2
    		exit 1
    	fi
	[ -s "$BaselineJobsJsonTmpFile" ] && mv "$BaselineJobsJsonTmpFile" "$BaselineJobsJsonFile"
    fi

    #
    # Baseline extraction
    # grab the most recent ashs PMC-T2 run
    # If there is one,
    #   Set the AshsPmcT2JobId and you have all the baseline inputs for aloha
    # else
    #   Find the T1 dicom, convert to nifti, necktrim, ashs-pmc-t1
    #   Find the T2 dicom, convery to nifti, ashs-pmc-t2
    #   Set the AshsPmcT2JobId
    #

    AlohaArgFlag='"-b"'
    BaselineT1NiftiTrimmedJson=$(jq -r --argjson AlohaArgFlag '"-b"' --argjson ClassificationMeasurement '"T1"' -f alohaFindT1T2.jq  "$BaselineSessionJsonFile" | jq -r 'select( (.FileType == "nifti") and (.FileTags | any(. == "Trimmed")) ) ')
    if [ -z "$BaselineT1NiftiTrimmedJson" ] || [ "$BaselineT1NiftiTrimmedJson" = "null" ] || (echo "$opt_f" | grep -q -E 'IgnoreBaselineT1NiftiTrimmedJson|RunBaselineT1Dcm2NiixGear|RunBaselineT1NecktrimGear')
    then
    	BaselineT1DicomJson=$(jq -r --argjson AlohaArgFlag '"-b"' --argjson ClassificationMeasurement '"T1"' -f alohaFindT1T2.jq  "$BaselineSessionJsonFile" | jq -r 'select( (.FileType == "archive") or (.FileType == "dicom") ) ')
	if [ -z "$BaselineT1DicomJson" ] || (echo "$opt_f" | grep -q 'IgnoreBaselineT1DicomJson')
	then
	    echo "${CmdName} : Missing Baseline T1 Dicom for ${BaselineSessionLabel}(${BaselineSessionId}). Skipping" 1>&2
	    BaselineT1NiftiTrimmedJson='{ "Missing": true }'
	else
	    if [ -z "$opt_f" ] || (echo "$opt_f" | grep -q 'RunBaselineT1Dcm2NiixGear')
	    then
		BaselineT1DicomFileId=$(echo "$BaselineT1DicomJson" | jq -r '.FileId')
		BaselineT1Dicom2NiftiJobId=$(sys fwRunGear -w -t "$GearTags" -g dcm2niix -i dcm2niix_input "$BaselineT1DicomFileId")
    		if [ "$?" != 0 ]
    		then
    		    echo "${CmdName} : fwRunGear failed fwRunGear -w -t '$GearTags' -g dcm2niix -i dcm2niix_input '$BaselineT1DicomFileId'" 1>&2
    		    exit 1
    		fi
		
		BaselineT1NiftiFileId=$(fwget -1 -j "$BaselineT1Dicom2NiftiJobId" | jq -r '.outputs[] | select(.type == "nifti") | .file_id')

		BaselineT1DicomTags=$(fwTag "$BaselineT1DicomFileId")
		[ -n "$BaselineT1DicomTags" ] && sys fwTag -q -t "$BaselineT1DicomTags" "$BaselineT1NiftiFileId"
	    else
		BaselineT1DicomFileId=$(echo "$BaselineT1DicomJson" | jq -r '.FileId')
		echo Faking fwRunGear -w -t "$GearTags" -g dcm2niix -i dcm2niix_input "$BaselineT1DicomFileId" 1>&2

		BaselineT1NiftiFileId=$(jq -r --argjson AlohaArgFlag '"-b"' --argjson ClassificationMeasurement '"T1"' -f alohaFindT1T2.jq  "$BaselineSessionJsonFile" | jq -r 'select( (.FileType == "nifti") and ((.FileTags | any(. == "Trimmed")) | not) )' | jq -r '.FileId')
	    fi

	    if [ -z "$opt_f" ] ||(echo "$opt_f" | grep -q 'RunBaselineT1NecktrimGear')
	    then
		BaselineT1NecktrimJobId=$(sys fwRunGear -w -t "$GearTags" -g 'necktrim' -i 'file' "$BaselineT1NiftiFileId")
    		if [ "$?" != 0 ]
    		then
    		    echo "${CmdName} : fwRunGear failed fwRunGear -w -t '$GearTags' -g 'necktrim' -i 'file' '$BaselineT1DicomFileId'" 1>&2
    		    exit 1
    		fi

		BaselineT1NiftiTrimmedFileId=$(fwget -1 -j "$BaselineT1NecktrimJobId" | jq -r '.outputs[] | select(.type == "nifti") | .file_id')
	    
		BaselineT1NiftiTags=$(fwTag "$BaselineT1NiftiTrimmedFileId")
		[ -n "$BaselineT1NiftiTags" ] && sys fwTag -q -t "$BaselineT1NiftiTags" "$BaselineT1NiftiTrimmedFileId"
		
		sys fwget -1 -raGz "$BaselineSessionId" > "$BaselineSessionJsonFile"
	    else
		echo Faking fwRunGear -w -t "$GearTags" -g 'necktrim' -i 'file' "$BaselineT1NiftiFileId" 1>&2
	    fi

	    BaselineT1NiftiTrimmedJson=$(jq -r --argjson AlohaArgFlag '"-b"' --argjson ClassificationMeasurement '"T1"' -f alohaFindT1T2.jq  "$BaselineSessionJsonFile" | jq -r 'select( (.FileType == "nifti") and (.FileTags | any(. == "Trimmed")) ) ')
	fi
    fi
    BaselineT1NiftiTrimmedFileId=$(echo "$BaselineT1NiftiTrimmedJson" | jq -r '.FileId')

    AlohaArgFlag='"-c"'
    BaselineT2NiftiJson=$(jq -r --argjson AlohaArgFlag '"-c"' --argjson ClassificationMeasurement '"T2"' -f alohaFindT1T2.jq  "$BaselineSessionJsonFile" | jq -s -r '[sort_by(.FileTimestamp) | .[] | select( .FileType == "nifti" ) ] | last' )
    if [ -z "$BaselineT2NiftiJson" ] || [ "$BaselineT2NiftiJson" = "null" ] || (echo "$opt_f" | grep -q -E 'IgnoreBaselineT2NiftiJson|RunBaselineT2Dcm2NiixGear')
    then
    	BaselineT2DicomJson=$(jq -r --argjson AlohaArgFlag '"-c"' --argjson ClassificationMeasurement '"T2"' -f alohaFindT1T2.jq  "$BaselineSessionJsonFile" | jq -r 'select( (.FileType == "archive") or (.FileType == "dicom") ) ')
	if [ -z "$BaselineT2DicomJson" ] || (echo "$opt_f" | grep -q 'IgnoreBaselineT2DicomJson')
	then
	    echo "${CmdName} : Missing Baseline T2 for ${BaselineSessionLabel}(${BaselineSessionId}). Skipping" 1>&2
	    BaselineT2NiftiJson='{ "Missing": true }'
	else
	    if [ -z "$opt_f" ] || (echo "$opt_f" | grep -q 'RunBaselineT2Dcm2NiixGear')
	    then
		BaselineT2DicomFileId=$(echo "$BaselineT2DicomJson" | jq -r '.FileId')
		BaselineT2Dicom2NiftiJobId=$(sys fwRunGear -w -t "$GearTags" -g dcm2niix -i dcm2niix_input "$BaselineT2DicomFileId")
    		if [ "$?" != 0 ]
    		then
    		    echo "${CmdName} : fwRunGear failed fwRunGear -w -t '$GearTags' -g dcm2niix -i dcm2niix_input '$BaselineT2DicomFileId'" 1>&2
    		    exit 1
    		fi
		
		BaselineT2NiftiFileId=$(fwget -1 -j "$BaselineT2Dicom2NiftiJobId" | jq -r '.outputs[] | select(.type == "nifti") | .file_id')

		BaselineT2DicomTags=$(fwTag "$BaselineT2DicomFileId")

		[ -n "$BaselineT2DicomTags" ] && sys fwTag -q -t "$BaselineT2DicomTags" "$BaselineT2NiftiFileId"
		sys fwget -1 -raGz "$BaselineSessionId" > "$BaselineSessionJsonFile"
	    else
		BaselineT2DicomFileId=$(echo "$BaselineT2DicomJson" | jq -r .'FileId')
		echo Faking fwRunGear -w -t "$GearTags" -g dcm2niix -i dcm2niix_input "$BaselineT2DicomFileId" 1>&2
	    fi

	    BaselineT2NiftiJson=$(jq -r --argjson AlohaArgFlag '"-c"' --argjson ClassificationMeasurement '"T2"' -f alohaFindT1T2.jq  "$BaselineSessionJsonFile" | jq -r 'select( .FileType == "nifti" ) ' | jq -s -r ' sort_by(.FileTimestamp)  | last')
	fi
    fi
    BaselineT2NiftiFileId=$(echo "$BaselineT2NiftiJson" | jq -r '.FileId')

    BaselineAshsPmcT1JobId=$( jq  -s -r '[ .[] | select( (.gear_info.name == "ashs") and (.detail.state == "complete") and (.config.config.ASHS_Atlases == "ASHS-PMC-T1") ) ] | sort_by(.created) | last | ._id' "$BaselineJobsJsonFile")
    if [ -z "$BaselineAshsPmcT1JobId" ] || [ "$BaselineAshsPmcT1JobId" = "null" ] || (echo "$opt_f" | grep -q -E 'IgnoreBaselineAshsPmcT1JobId|RunAshsPmcT1Gear')
    then
	if [ -z "$opt_f" ] || (echo "$opt_f" | grep -q 'RunAshsPmcT1Gear')
	then
	    BaselineAshsPmcT1JobId=$(fwRunGear -w -t "$GearTags" -g ashs -i T1w "$BaselineT1NiftiTrimmedFileId" -c '{"ASHS_Atlases": "ASHS-PMC-T1"}')
    	    if [ "$?" != 0 ]
    	    then
    		echo "${CmdName} : fwRunGear failed fwRunGear -w -t "$GearTags" -g ashs -i T1w '$BaselineT1NiftiTrimmedFileId' -c '{ASHS_Atlases: ASHS-PMC-T1}'" 1>&2
    		exit 1
    	    fi

	    sys fwfind -1 -j -r session="$BaselineSessionId" > "$BaselineJobsJsonTmpFile"
    	    if [ "$?" != 0 ]
    	    then
    		echo "${CmdName} : fwfind failed finding jobs for '$BaselineSessionLabel' ($BaselineSessionId)" 1>&2
    		exit 1
    	    fi
	    [ -s "$BaselineJobsJsonTmpFile" ] && mv "$BaselineJobsJsonTmpFile" "$BaselineJobsJsonFile"
	else
	    echo Faking fwRunGear -w -t "$GearTags" -g ashs -i T1w "$BaselineT1NiftiTrimmedFileId" -c '{"ASHS_Atlases": "ASHS-PMC-T1"}' 1>&2
	fi
    fi

    AlohaArgFlag='"-r"'
    BaselineT1LeftSegmentationJson=$( jq -r --argjson JobId "\"$BaselineAshsPmcT1JobId\"" 'select(._id == $JobId)' "$BaselineJobsJsonFile" | jq --argjson AlohaArgFlag '"-r"' -f alohaJob2FileIds.jq | jq --argjson Handedness '"Left"' '.Outputs[] | select(.FileModality == "SEG" and (.FileName | test("lfseg_heur")) and (.FileTags | any(. == $Handedness)) )' )

    if [ -z "$BaselineT1LeftSegmentationJson" ] || [ "$BaselineTLeftSegmentationJson" = "null" ] || (echo "$opt_f" | grep -q 'IgnoreBaselineT1LeftSegmentationJson')
    then
    	echo "${CmdName} : Missing baseline T1 Left Segmentation" 1>&2
	BaselineT1LeftSegmentationJson='{ "Missing": true }'
    fi

    AlohaArgFlag='"-s"'
    BaselineT1RightSegmentationJson=$( jq -r --argjson JobId "\"$BaselineAshsPmcT1JobId\"" 'select(._id == $JobId)' "$BaselineJobsJsonFile" | jq --argjson AlohaArgFlag '"-s"' -f alohaJob2FileIds.jq | jq --argjson Handedness '"Right"' '.Outputs[] | select(.FileModality == "SEG" and (.FileName | test("lfseg_heur")) and (.FileTags | any(. == $Handedness)) )' )
    if [ -z "$BaselineT1RightSegmentationJson" ] || [ "$BaselineT1RightSegmentationJson" = "null" ] || (echo "$opt_f" | grep -q 'IgnoreBaselineT1RightSegmentationJson')
    then
    	echo "${CmdName} : Missing baseline T1 Right Segmentation" 1>&2
	BaselineT1RightSegmentationJson='{ "Missing": true }'
    fi

    #
    # Find the last ASHS PMC-T2 run on this session, and grab the JobId.
    #
    BaselineAshsPmcT2JobId=$(jq  -s -r '[ .[] | select( (.gear_info.name == "ashs") and (.detail.state == "complete") and (.config.config.ASHS_Atlases == "ASHS-PMC-T2") ) ] | sort_by(.created) | last | ._id' "$BaselineJobsJsonFile")
    if [ -z "$BaselineAshsPmcT2JobId" ] || [ "$BaselineAshsPmcT2JobId" = 'null' ] || (echo "$opt_f" | grep -q -E 'IgnoreBaselineAshsPmcT2JobId|RunBaselineAshsPmcT2Gear' )
    then
	if [ -z "$opt_f" ] || (echo "$opt_f" | grep -q 'RunBaselineAshsPmcT2Gear')
	then
	    BaselineAshsPmcT2JobId=$(fwRunGear -w -t "$GearTags" -g ashs -i T1w "$BaselineT1NiftiTrimmedFileId" -i T2w "$BaselineT2NiftiFileId" -c '{"ASHS_Atlases": "ASHS-PMC-T2"}')
    	    if [ "$?" != 0 ]
    	    then
    		echo "${CmdName} : fwRunGear failed fwRunGear -w -t "$GearTags" -g ashs -i T1w '$BaselineT1NiftiTrimmedFileId' -i T2w "$BaselineT2NiftiFileId" -c '{ASHS_Atlases: ASHS-PMC-T2}'" 1>&2
    		exit 1
    	    fi

	    sys fwfind -1 -j -r session="$BaselineSessionId" > "$BaselineJobsJsonTmpFile"
    	    if [ "$?" != 0 ]
    	    then
    		echo "${CmdName} : fwfind failed finding jobs for '$BaselineSessionLabel' ($BaselineSessionId)" 1>&2
    		exit 1
    	    fi
	    [ -s "$BaselineJobsJsonTmpFile" ] && mv "$BaselineJobsJsonTmpFile" "$BaselineJobsJsonFile"
	else
	    echo Faking fwRunGear -w -t "$GearTags" -g ashs -i T1w "$BaselineT1NiftiTrimmedFileId" -i T2w "$BaselineT2NiftiFileId" -c '{"ASHS_Atlases": "ASHS-PMC-T2"}' 1>&2
	fi
    fi
    
    AlohaArgFlag='"-t"'
    BaselineT2LeftSegmentationJson=$( jq -r --argjson JobId "\"$BaselineAshsPmcT2JobId\"" 'select(._id == $JobId)' "$BaselineJobsJsonFile" | jq --argjson AlohaArgFlag '"-t"' -f alohaJob2FileIds.jq | jq --argjson Handedness '"Left"' '.Outputs[] | select(.FileModality == "SEG" and (.FileName | test("lfseg_heur")) and (.FileTags | any(. == $Handedness)) )' )
    if [ -z "$BaselineT2LeftSegmentationJson" ] || [ "$BaselineT2LeftSegmentationJson" = "null" ] || (echo "$opt_f" | grep -q 'IgnoreBaselineT2LeftSegmentationJson')
    then
    	echo "${CmdName} : Missing baseline T2 Left Segmentation" 1>&2
    	BaselineT2LeftSegmentationJson='{ "Missing": true }'
    fi

    AlohaArgFlag='"-u"'
    BaselineT2RightSegmentationJson=$( jq -r --argjson JobId "\"$BaselineAshsPmcT2JobId\"" 'select(._id == $JobId)' "$BaselineJobsJsonFile" | jq --argjson AlohaArgFlag '"-u"' -f alohaJob2FileIds.jq | jq --argjson Handedness '"Right"' '.Outputs[] | select(.FileModality == "SEG" and (.FileName | test("lfseg_heur")) and (.FileTags | any(. == $Handedness)) )' )    
    if [ -z "$BaselineT2RightSegmentationJson" ] || [ "$BaselineT2RightSegmentationJson" = "null" ] || (echo "$opt_f" | grep -q 'IgnoreBaselineT2RightSegmentationJson')
    then
    	echo "${CmdName} : Missing baseline T2 Right Segmentation" 1>&2
    	BaselineT2RightSegmentationJson='{ "Missing": true }'
    fi

    #
    # Followup Session Info should include session data
    #
    JobDate=$(date +%Y-%m-%dT%H:%M:%S%:z)
    JobLabel='Aloha'
    JobId=
    [ -n "$opt_j" ] && JobId="$opt_j"
    
    JobJson="{\"JobLabel\": \"$JobLabel\", \"JobId\": \"$JobId\", \"JobDate\": \"$JobDate\"}"
    
    jq -r -n	 --argjson JobInfo "$JobJson"							\
    		 --argjson Baseline "$BaselineJson"						\
    		 --argjson BaselineT1 "$BaselineT1NiftiTrimmedJson"				\
      		 --argjson BaselineT2 "$BaselineT2NiftiJson"					\
          	 --argjson BaselineT1LeftSegmentation "$BaselineT1LeftSegmentationJson" 	\
          	 --argjson BaselineT1RightSegmentation "$BaselineT1RightSegmentationJson" 	\
          	 --argjson BaselineT2LeftSegmentation "$BaselineT2LeftSegmentationJson" 	\
          	 --argjson BaselineT2RightSegmentation "$BaselineT2RightSegmentationJson" 	\
          		   '    { "JobInfo": $JobInfo} + {"Baseline": (
    		   	       $Baseline 
    			       + {
    			          "T1": $BaselineT1
     			        , "T2": $BaselineT2
     			        , "T1LeftSegmentation": $BaselineT1LeftSegmentation
     			        , "T1RightSegmentation": $BaselineT1RightSegmentation
     			        , "T2LeftSegmentation": $BaselineT2LeftSegmentation
     			        , "T2RightSegmentation": $BaselineT2RightSegmentation
    			          })
     			 }'									\
			 > "$BaselineJsonFile"

    FollowupsJsonFile="${TmpDir}/Followups.json"
    rm -f "$FollowupsJsonFile"

    for FollowupSessionId in $(jq -r '.Followups[] | .SessionId' "$SortedSessionsJsonFile")
    do
	#
	# Single Followup Session
	#
    	FollowupSessionJsonFile="${TmpDir}/FollowupSession.json"
    	jq -r '..|select(._id == "'"$FollowupSessionId"'")?' "$SubjectJsonFile" > "$FollowupSessionJsonFile"
	if [ -S "$FollowupSessionJsonFile" ]
	then
	    echo "${CmdName}: No followup session found" 1>&2
	    exit 11
	fi

	#
	# SessionId, SessionLabel, SessionScanDateTime
	#
    	FollowupJson=$(jq -r -L "$FwLibDir" 'include "FwLib"; ..|select(._id == "'"$FollowupSessionId"'")? | ({"SessionId": ._id, "SessionLabel": .label, "SessionScanDateTime": sessionScanDateTime(.)})' "$SubjectJsonFile")
    
    	FollowupSessionLabel=$(echo "$FollowupJson" | jq -r '.SessionLabel')
        [ -n "$opt_v" ] && echo -n "${CmdName}: FollowupSession = '${FollowupSessionLabel}(${FollowupSessionId})': " 1>&2
    
	AlohaArgFlag='"-f"'	
    	FollowupT1NiftiTrimmedJson=$(jq -r --argjson AlohaArgFlag '"-f"' --argjson ClassificationMeasurement '"T1"' -f alohaFindT1T2.jq  "$FollowupSessionJsonFile" | jq -r 'select( (.FileType == "nifti") and (.FileTags | any(. == "Trimmed")) ) ' | jq -s -r ' sort_by(.FileTimestamp)  | last' )
	if [ -z "$FollowupT1NiftiTrimmedJson" ] || [ "$FollowupT1NiftiTrimmedJson" = 'null' ] || (echo "$opt_f" | grep -q -E 'IgnoreFollowupT1NiftiTrimmedJson|RunFollowupT1Dcm2NiixGear|RunFollowupT1NecktrimGear')
	then
    	    FollowupT1DicomJson=$(jq -r --argjson AlohaArgFlag '"-f"' --argjson ClassificationMeasurement '"T1"' -f alohaFindT1T2.jq  "$FollowupSessionJsonFile" | jq -r 'select( (.FileType == "archive") or (.FileType == "dicom") ) ' | jq -s -r ' sort_by(.FileTimestamp)  | last' )
	    if [ -z "$FollowupT1DicomJson" ] || [ "$FollowupT1DicomJson" = 'null' ] || (echo "$opt_f" | grep -q 'IgnoreFollowupT1DicomJson')
	    then
		echo " Missing Followup T1. Skipping" 1>&2
		FollowupT1NiftiJson='{ "Missing": true }'
	    else
		if [ -z "$opt_f" ] || (echo "$opt_f" | grep -q 'RunFollowupT1Dcm2NiixGear')
		then
		    FollowupT1DicomFileId=$(echo "$FollowupT1DicomJson" | jq -r '.FileId')
		    FollowupT1Dicom2NiftiJobId=$(sys fwRunGear -w -t "$GearTags" -g dcm2niix -i dcm2niix_input "$FollowupT1DicomFileId")
    		    if [ "$?" != 0 ]
    		    then
    			echo "${CmdName} : fwRunGear failed fwRunGear -w -t '$GearTags' -g dcm2niix -i dcm2niix_input '$FollowupT1DicomFileId'" 1>&2
    			exit 1
    		    fi
		
		    FollowupT1NiftiFileId=$(fwget -1 -j "$FollowupT1Dicom2NiftiJobId" | jq -r '.outputs[] | select(.type == "nifti") | .file_id')
	    
		    FollowupT1DicomTags=$(fwTag "$FollowupT1DicomFileId")
		    #
		    # fwTag needs the -q to keep the tags from being echoed to stdout and added to the followup json
		    #
		    [ -n "$FollowupT1DicomTags" ] && sys fwTag -q -t "$FollowupT1DicomTags" "$FollowupT1NiftiFileId"
		else
		    echo Faking fwRunGear -w -t "$GearTags" -g dcm2niix -i dcm2niix_input "$FollowupT1DicomFileId" 1>&2
		    FollowupT1DicomFileId=$(jq -r --argjson AlohaArgFlag '"-f"' --argjson ClassificationMeasurement '"T1"' -f alohaFindT1T2.jq  "$FollowupSessionJsonFile" | jq -r 'select( (.FileType == "nifti") and ((.FileTags | any(. == "Trimmed")) | not) )' | jq -r '.FileId')
		fi
	    fi
	    
	    if [ -z "$opt_f" ] || (echo "$opt_f" | grep -q 'RunFollowupT1NecktrimGear')
	    then
		    FollowupT1NecktrimJobId=$(sys fwRunGear -w -t "$GearTags" -g 'necktrim' -i 'file' "$FollowupT1NiftiFileId")
    		    if [ "$?" != 0 ]
    		    then
    			echo "${CmdName} : fwRunGear failed fwRunGear -w -t '$GearTags' -g 'necktrim' -i 'file' '$FollowupT1DicomFileId'" 1>&2
    			exit 1
    		    fi
		
		FollowupT1NiftiTrimmedFileId=$(fwget -1 -j "$FollowupT1NecktrimJobId" | jq -r '.outputs[] | select(.type == "nifti") | .file_id')
	    
		FollowupT1NiftiTags=$(fwTag "$FollowupT1NiftiTrimmedFileId")
		[ -n "$FollowupT1NiftiTags" ] && sys fwTag -q -t "$FollowupT1NiftiTags" "$FollowupT1NiftiTrimmedFileId"
	    else
		echo Faking fwRunGear -w -t "$GearTags" -g 'necktrim' -i 'file' "$FollowupT1NiftiFileId" 1>&2
	    fi

	    sys fwget -1 -raGz "$FollowupSessionId" > "$FollowupSessionJsonFile"
	    FollowupT1NiftiTrimmedJson=$(jq -r --argjson AlohaArgFlag '"-f"' --argjson ClassificationMeasurement '"T1"' -f alohaFindT1T2.jq "$FollowupSessionJsonFile" | jq -r 'select( (.FileType == "nifti") and (.FileTags | any(. == "Trimmed")) ) '| jq -s -r ' sort_by(.FileTimestamp)  | last' )
	fi

	AlohaArgFlag='"-g"'	
    	FollowupT2NiftiJson=$(jq -r --argjson AlohaArgFlag '"-g"' --argjson ClassificationMeasurement '"T2"' -f alohaFindT1T2.jq  "$FollowupSessionJsonFile" | jq -r 'select( .FileType == "nifti" ) '| jq -s -r ' sort_by(.FileTimestamp)  | last' )
	if [ -z "$FollowupT2NiftiJson" ] || [ "$FollowupT2NiftiJson" = "null" ] || (echo "$opt_f" | grep -q -E 'IgnoreFollowupT2NiftiJson|RunFollowupT2Dcm2NiixGear')
	then
    	    FollowupT2DicomJson=$(jq -r --argjson AlohaArgFlag '"-g"' --argjson ClassificationMeasurement '"T2"' -f alohaFindT1T2.jq  "$FollowupSessionJsonFile" | jq -r 'select( (.FileType == "archive") or (.FileType == "dicom") ) ' | jq -s -r ' sort_by(.FileTimestamp)  | last' )
	    if [ -z "$FollowupT2DicomJson" ] || [ "$FollowupT2DicomJson" = 'null' ] || (echo "$opt_f" | grep -q 'IgnoreFollowupT2DicomJson')
	    then
		echo "Missing Followup T2. Skipping" 1>&2
		FollowupT2NiftiJson='{ "Missing": true }'
	    else
		if [ -z "$opt_f" ] || (echo "$opt_f" | grep -q 'RunFollowupT2Dcm2NiixGear')
		then
		    FollowupT2DicomFileId=$(echo "$FollowupT2DicomJson" | jq -r '.FileId')
		    FollowupT2Dicom2NiftiJobId=$(sys fwRunGear -w -t "$GearTags" -g dcm2niix -i dcm2niix_input "$FollowupT2DicomFileId")
    		    if [ "$?" != 0 ]
    		    then
    			echo "${CmdName} : fwRunGear failed fwRunGear -w -t '$GearTags' -g dcm2niix -i dcm2niix_input '$FollowupT2DicomFileId'" 1>&2
    			exit 1
    		    fi
		
		    FollowupT2NiftiFileId=$(fwget -1 -j "$FollowupT2Dicom2NiftiJobId" | jq -r '.outputs[] | select(.type == "nifti") | .file_id')
	    
		    FollowupT2DicomTags=$(fwTag "$FollowupT2DicomFileId")

		    #
		    # fwTag needs the -q to keep the tags from being echoed to stdout and added to the followup json
		    #
		    [ -n "$FollowupT2DicomTags" ] && sys fwTag -q -t "$FollowupT2DicomTags" "$FollowupT2NiftiFileId"

		    sys fwget -1 -raGz "$FollowupSessionId" > "$FollowupSessionJsonFile"
		else
		    FollowupT2DicomFileId=$(echo "$FollowupT2DicomJson" | jq -r .'FileId')
		    echo Faking fwRunGear -w -t "$GearTags" -g dcm2niix -i dcm2niix_input "$FollowupT2DicomFileId" 1>&2
		fi
		
		sys fwget -1 -raGz "$FollowupSessionId" > "$FollowupSessionJsonFile"
		FollowupT2NiftiJson=$(jq -r --argjson AlohaArgFlag '"-g"' --argjson ClassificationMeasurement '"T2"' -f alohaFindT1T2.jq  "$FollowupSessionJsonFile" | jq -r 'select( .FileType == "nifti" ) ' | jq -s -r ' sort_by(.FileTimestamp)  | last' )
	    fi
	fi

	if [ -n "$opt_v" ] && (echo "$FollowupT1NiftiTrimmedJson" "$FollowupT2NiftiJson" | jq -r -s '[ ..|.Missing? ] | any(.)' | grep -q 'false')
	then
	    echo "Found T1 and T2 Niftis. Processing" 1>&2
	fi
	
    	jq -r -n --argjson Followup "$FollowupJson"				\
    	      	 --argjson FollowupT1 "$FollowupT1NiftiTrimmedJson"		\
    	         --argjson FollowupT2 "$FollowupT2NiftiJson"			\
    		 '$Followup + {"T1": $FollowupT1, "T2": $FollowupT2}' >> "$FollowupsJsonFile"

    done 
    
    jq -r -n --slurpfile Baseline "$BaselineJsonFile" --slurpfile Followups "$FollowupsJsonFile" '($Baseline[]) + ({ "Followups": $Followups })' > "$AlohaInputsJsonFile"
    
    if echo "$opt_o" | grep -qi 'stdout'
    then
        cat "$AlohaInputsJsonFile"
    fi
    
    if echo "$opt_o" | grep -qi 'site'
    then
        sys fwuploadfile -p "$SubjectId" "$AlohaInputsJsonFile"
    fi

fi

if [ -n "$opt_a" ]
then
    AlohaInputsJsonFilename=$(basename "$AlohaInputsJsonFile")
    AlohaInputsJsonFileId=$(fwget -1 -raz "$SubjectId" | jq -r '.files[] | select(.name == "'"$AlohaInputsJsonFilename"'") | .file_id')
    sys fwget -v -f --download --download-dir "$TmpDir" "$AlohaInputsJsonFileId"
fi

DownloadedAllFiles=true
if [ -n "$opt_d" ]
then
    for FileId in $(jq -r '.Baseline | ..|.FileId? | select(.)' $AlohaInputsJsonFile)
    do
        sys fwget -v -f --download --download-dir "$BaselineDir" "$FileId"
        if [ "$?" != 0 ]
        then
    	    echo "${CmdName} : downloading file '$FileId' failed" 1>&2
    	    DownloadAllFiles=false
        fi
    done
    
    for FollowupSessionId in $(jq -r '.Followups[].SessionId' "$AlohaInputsJsonFile")
    do
            [ -n "$opt_v" ] && echo "FollowupSessionId = '$FollowupSessionId'" 1>&2
    
    	FollowupSessionLabel=$(jq -r '.Followups[] | select(.SessionId == "'"$FollowupSessionId"'") | .SessionLabel' "$AlohaInputsJsonFile")
    	
    	FollowupSessionDir="${FollowupDir}/${FollowupSessionLabel}"
    	[ -e "$FollowupSessionDir" ] || mkdir -p "$FollowupSessionDir"
    
    	FollowupSessionJsonFile="${FollowupSessionDir}/FollowupSession.json"
    	jq -r '.Followups[] | select(.SessionId == "'"$FollowupSessionId"'")' "$AlohaInputsJsonFile" > "$FollowupSessionJsonFile"
    	
    	for FileId in $(jq -r '..|.FileId? | select(.)' "$FollowupSessionJsonFile")
    	do
    	    sys fwget -v -f --download --download-dir "$FollowupSessionDir" "$FileId"
    	    if [ "$?" != 0 ]
	    then
    		echo "${CmdName} : downloading file '$FileId' failed" 1>&2
    		DownloadAllFiles=false
    	    fi
        done
    done
fi

if [ -n "$opt_r" ]
then
	AlohaBaselineArgs=()

	BaselineSessionScanDateTime=$(jq -r '.Baseline.SessionScanDateTime' "$AlohaInputsJsonFile")
	BaselineSessionScanDate=$(date -d "$BaselineScanDateTime" "+%Y-%m-%d")

	# *** Should verify aspect ratios for T1/T2 are acceptable

	#skip the session info keys
	for k in $(jq -r '.Baseline | keys[] as $k | select((.[$k]|type) == "object") | $k' "$AlohaInputsJsonFile")
	do
		AlohaArgFlag=$(jq -r '.Baseline.'"$k"' | .AlohaArgFlag' "$AlohaInputsJsonFile")
		FileName=$(jq -r '.Baseline.'"$k"' | .FileName' "$AlohaInputsJsonFile")
		InputFilePath="${BaselineDir}/${FileName}"
		AlohaBaselineArgs+=( "$AlohaArgFlag" "$InputFilePath" )
	done

	AlohaFollowupArgs=()
	for FollowupSessionId in $(jq -r '.Followups[].SessionId' "$AlohaInputsJsonFile")
	do
	    RunAloha=true

    	    FollowupSessionScanDateTime=$(jq -r '.Followups[] | select(.SessionId == "'"$FollowupSessionId"'") | .SessionScanDateTime' "$AlohaInputsJsonFile")
	    if [ -z "$FollowupSessionScanDateTime" ] || [ "$FollowupSessionScanDateTime" = 'null' ]
	    then
		echo "${CmdName} : No FollowupSessionScanDateTime for '${FollowupSessionLabel}(${FollowupSessionId})'" 1>&2
	    fi

	    FollowupSessionScanDate=$(date -d "$FollowupSessionScanDateTime" "+%Y-%m-%d")

    	    FollowupSessionLabel=$(jq -r '.Followups[] | select(.SessionId == "'"$FollowupSessionId"'") | .SessionLabel' "$AlohaInputsJsonFile")
	    if [ -z "$FollowupSessionLabel" ] || [ "$FollowupSessionLabel" = 'null' ]
	    then
		echo "${CmdName} : No FollowupSessionLabel for '${FollowupSessionLabel}(${FollowupSessionId})'" 1>&2
 										    
		RunAloha=false
	    fi

            [ -n "$opt_v" ] && echo "${CmdName} : FollowupSessionLabel = '$FollowupSessionLabel'" 1>&2
    
	    FollowupSessionT1AlohaArgFlag=$(jq -r '.Followups[] | select(.SessionId == "'"$FollowupSessionId"'") | .T1.AlohaArgFlag' "$AlohaInputsJsonFile")
	    if [ -z "$FollowupSessionT1AlohaArgFlag" ] || [ "$FollowupSessionT1AlohaArgFlag" = 'null' ]
	    then
		echo "${CmdName} : No FollowupSessionT1AlohaFlag for '${FollowupSessionLabel}(${FollowupSessionId})'" 1>&2
 										    
		RunAloha=false
	    fi

	    FollowupSessionT1FileName=$(jq -r '.Followups[] | select(.SessionId == "'"$FollowupSessionId"'") | .T1.FileName' "$AlohaInputsJsonFile")
	    if [ -z "$FollowupSessionT1FileName" ] || [ "$FollowupSessionT1FileName" = 'null' ]
	    then
		echo "${CmdName} : No FollowupSessionT1FileName for '${FollowupSessionLabel}(${FollowupSessionId})'" 1>&2
 										    
		RunAloha=false
	    fi

	    FollowupSessionT2AlohaArgFlag=$(jq -r '.Followups[] | select(.SessionId == "'"$FollowupSessionId"'") | .T2.AlohaArgFlag' "$AlohaInputsJsonFile")
	    if [ -z "$FollowupSessionT2AlohaArgFlag" ] || [ "$FollowupSessionT2AlohaArgFlag" = 'null' ]
	    then
		echo "${CmdName} : No FollowupSessionT2T2AlohaArgFlag for '${FollowupSessionLabel}(${FollowupSessionId})'" 1>&2
 										    
		RunAloha=false
	    fi

	    FollowupSessionT2FileName=$(jq -r '.Followups[] | select(.SessionId == "'"$FollowupSessionId"'") | .T2.FileName' "$AlohaInputsJsonFile")
	    if [ -z "$FollowupSessionT2FileName" ] || [ "$FollowupSessionT2FileName" = 'null' ]
	    then
		echo "${CmdName} : No FollowupSessionT2FileName for '${FollowupSessionLabel}(${FollowupSessionId})'" 1>&2
 										    
		RunAloha=false
	    fi

	    [ -n "$opt_v" ] && echo "${CmdName} : RunAloha = '$RunAloha'" 1>&2
	    
	    if [ "$RunAloha" = 'true' ]
	    then
    		FollowupSessionDir="${FollowupDir}/${FollowupSessionLabel}"
    		FollowupSessionT1FilePath="${FollowupSessionDir}/${FollowupSessionT1FileName}"
    		FollowupSessionT2FilePath="${FollowupSessionDir}/${FollowupSessionT2FileName}"

		AlohaFollowupArgs+=( "$FollowupSessionT1AlohaArgFlag" "$FollowupSessionT1FilePath" )
		AlohaFollowupArgs+=( "$FollowupSessionT2AlohaArgFlag" "$FollowupSessionT2FilePath" )

		if [ -n "$opt_f" ] && (echo "$opt_f" | grep -q 'IgnoreAlohaRun')
		then
			echo "${CmdName}: Faking aloha_main.sh" 1>&2
		else
		    sys aloha_main.sh "${AlohaBaselineArgs[@]}" "${AlohaFollowupArgs[@]}" -w "$AlohaWorkDir"
		    ExitCode="$?"
		    if [ "$ExitCode" != 0 ]
		    then
			echo "${CmdName} : aloha_main.sh failed '${ExitCode}'" 1>&2
			continue
		    fi
		fi

		AlohaLeftVolumeTxtFile="${AlohaWorkDir}/results/volumes_left.txt"
		AlohaRightVolumeTxtFile="${AlohaWorkDir}/results/volumes_right.txt"
		SubjectLeftVolumeTxtFile="${TmpDir}/${BaselineSessionLabel}-${FollowupSessionLabel}-LeftVolume.txt"
		SubjectRightVolumeTxtFile="${TmpDir}/${BaselineSessionLabel}-${FollowupSessionLabel}-RightVolume.txt"

		(echo "SessionScanDate,$BaselineSessionScanDate,$FollowupSessionScanDate"
		 cat "$AlohaLeftVolumeTxtFile") | sys tee "$SubjectLeftVolumeTxtFile"

		(echo "SessionScanDate,$BaselineSessionScanDate,$FollowupSessionScanDate"
		 cat "$AlohaRightVolumeTxtFile") | sys tee "$SubjectRightVolumeTxtFile"
		
		if echo "$opt_o" | grep -qi 'site'
		then
		    sys fwuploadfile -v -t 'AlohaOutput,HippocampalVolume,Left' -p "$SubjectId" "$SubjectLeftVolumeTxtFile" 
		    sys fwuploadfile -v -t 'AlohaOutput,HippocampalVolume,Right' -p "$SubjectId" "$SubjectRightVolumeTxtFile"
		fi

	    else
		echo "${CmdName} : Invalid session aloha arguments for '${FollowupSessionLabel}(${FollowupSessionId})'. Skipping" 1>&2
	    fi
	done
fi

if [ -n "$opt_A" ]
then
    LeftVolumeFileIds=( $( sys fwget -1 -r "$SubjectId" | jq -r '.files[] | select( (.tags | any("HippocamplVolume")) and (.tags | any(. == "Left")) ) | .file_id' ) )
    RightVolumeFileIds=( $( sys fwget -1 -r "$SubjectId" | jq -r '.files[] | select( (.tags | any("HippocamplVolume")) and (.tags | any(. == "Right")) ) | .file_id' ) )

    LeftVolumeFilenames=( $( sys fwget -1 -f --download --download-dir "${TmpDir}" "${LeftVolumeFileIds[@]}" | sed "s/^.*=> //; s/ / -l /g; s/^/-l /") )
    RightVolumeFilenames=( $( sys fwget -1 -f --download --download-dir "${TmpDir}" "${RightVolumeFileIds[@]}" | sed "s/^.*=> //; s/ / -r /g; s/^/-r /" ) )

    AlohaSubjectAtrophyRatesCsvFile="${TmpDir}/${SubjectLabel}AtrophyRates.csv"
    sys ./calculateAtrophyRates "${LeftVolumeFilenames[@]}" "${RightVolumeFilenames[@]}" > "$AlohaSubjectAtrophyRatesCsvFile"

    [ -n "$opt_v" ] && cat "$AlohaSubjectAtrophyRatesCsvFile"
fi

exit
#
# Dict to CSV jq code from 
#    https://stackoverflow.com/questions/32960857/how-to-convert-arbitrary-simple-json-to-csv-using-jq
#
jq -r -f alohaSessionReport.jq /tmp/aloharun.json | jq -f alohaFlattenDict.jq | jq -s -r '(.[0] | keys_unsorted) as $keys | $keys, map([.[ $keys[] ]])[] | @csv'

