#!/bin/bash -x

CmdName=$(basename "$0")
Syntax="${CmdName} [-c config][-n][-i ProjectId|SubjectId][-m extra-large|supersize][-s VerifyInputs|RunReport|Aloha|CalculateAtrophyRates][-v][(VerifyAlohaInputs|CompileReport|RunAloha|CalculateAtrophy)]" 

function sys {
	[ -n "${opt_n}${opt_v}" ] && echo "$@" 1>&2
	[ -n "$opt_n" ] || "$@"
}


while getopts c:i:m:ns:v arg
do
	case "$arg" in
		c|m|n|i|s|v)
			eval "opt_${arg}='${OPTARG:=1}'"
			;;
	esac
done

shift $(("$OPTIND" - 1))

if [ -n "$opt_c" ]
then
	ConfigJsonFile="$opt_c"
else
	ConfigJsonFile="${FLYWHEEL}/config.json"
fi

jq -r . "$ConfigJsonFile"

JobId=$(jq -r '.job.id | select(.)' "$ConfigJsonFile")

InputDir=/flywheel/v0/input
TmpDir=/tmp/aloha

[ -d "$TmpDir" ] || mkdir -p "$TmpDir"

if [ -n "$opt_i" ]
then
    ParentCount=$(fwget -1 6740a4d1f2eb9f113bdf6ec1 | jq -r '.parents[]' | wc -l)
    if [ "$ParentCount" == 0 ]
    then
	echo "${CmdName} : -i '$opt_i' can not be found.  Exiting" 1>&2
	exit 1
    elif [ "$ParentCount" == 1 ]
    then
	SubjectIds=( $(sys fwget -1 -r "$opt_i" | jq -r '.subjects[]._id') )
    elif [ "$ParentCount" == 2 ]
    then
	SubjectIds=( $opt_i )
    else
	echo "${CmdName} : -i '$opt_i' : unknown container type.  Exiting" 1>&2
	exit 1
    fi
else
    if ! [ -e "$ConfigJsonFile" ]
    then
	echo "${CmdName} : No Project, Subject Id provided and no config file.  Exiting" 1>&2
	exit 1
    fi		

    SubjectIds=( $(jq -r '.job.id' "$ConfigJsonFile" | fwget -1 -j | jq -r '.parents.subject') )
fi

[ -n "$opt_v" ] && echo "SubjectIds = '${SubjectIds[@]}'" 1>&2

AlohaDriverArgs=( '-v' '-u' '-o' 'stdout,site' '-d' '-r' '-A' '-j' "$JobId")

Stages=( 'VerifyInputs' )
if [ -n "$opt_s" ]
then
    # *** Would be nice to accept a leading +|= to add or override
    Stages=( $(echo "$opt_s" | sed 's/, */ /g') )
    AlohaDriverArgs=( '-v' '-j' "$JobId" )
else
    ConfigStages=$(jq -r '.config.Stages | select(.)' "$ConfigJsonFile")
    if [ -n "$ConfigStages" ] && (echo "$ConfigStages" | grep -v -q default)
    then
	Stages=( $(echo "$ConfigStages" | sed 's/, */ /g') )
	AlohaDriverArgs=( '-v' '-j' "$JobId" )
    fi
fi

for i in "${Stages[@]}"
do
	case "$i" in
     	    VerifyAlohaInputs)
		AlohaDriverArgs+=( '-u' '-o' 'stdout,site' )
		;;
	    
	    CompileReport)
		;;
	    
	    RunAloha)
		AlohaDriverArgs+=( '-d' '-r' '-A' )
		;;

	    CalculateAtrophyRates)
		AlohaDriverArgs+=( '-A' )
	esac
done

if [ -n "$opt_m" ]
then
    AlohaDriverArgs+=( '-m' "$opt_m" )
fi

n=1
for SubjectId in "${SubjectIds[@]}"
do
    echo "$SubjectId ${n}/${#SubjectIds[@]}" 1>&2
    sys alohaDriver "${AlohaDriverArgs[@]}" "$SubjectId"
done
